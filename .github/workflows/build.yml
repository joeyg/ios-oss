name: Develop branch push
on:
  # schedule:
  #   - cron:  '30 5 * * *'
  push:
    branches:
      - main


jobs:
  unit-tests:

    name: Unit Tests

    runs-on: macos-12

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
    - name: Download GraphQL Schema
        run: bin/apollo-schema-download.sh
    - name: Bootstrap
        run: make bootstrap

    - name: Run tests
        run: make test
 
    - name: Publish build and test results
      run: |
        cd TestResults
        zip -r ../testresults.zip *
        cd -
        HOSTNAME=$(hostname)
        curl -F "key=EE777694-4B67-4FA6-84EE-65EFDB6BFEAB" -F "log=@testresults.zip;type=application/zip" -F "hostname=$HOSTNAME" https://illuminatebuild.com/testupload -v
        LOG=$(ls -drt results/Logs/Build/* | grep "xcactivitylog" | tail -n 1)
        curl -F "zld=false" -F "hostname=$HOSTNAME" -F "key=EE777694-4B67-4FA6-84EE-65EFDB6BFEAB" -F "log=@${LOG}" https://illuminatebuild.com/upload -v
    
    - name: Publish docs
      run: |
        xcodebuild docbuild -allowProvisioningUpdates -scheme DuckDuckGo  -derivedDataPath results -destination 'platform=iOS Simulator,name=iPhone 13 Pro Max' OTHER_DOCC_FLAGS="--output-path ./docs --hosting-base-path api/docs/35CDDFBC-7E9E-46C5-AC6E-0C92EDBFD231/"
        cd docs
        zip -r ../docs.zip *
        cd -
        curl -F "key=EE777694-4B67-4FA6-84EE-65EFDB6BFEAB" -F "docs=@docs.zip;type=application/zip" https://illuminatebuild.com/docsupload -X POST -v



